import string

from flask import Flask, render_template, redirect, request, render_template_string, url_for
from jinja2 import Template, Markup
import random
app = Flask(__name__)
comments = [{
    "author": "John Doe",
    "text": "Nulla vel metus scelerisque ante sollicitudin. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis. Fusce condimentum nunc ac nisi vulputate fringilla. Donec lacinia congue felis in faucibus."
},
    {
        "author": "John Doe",
        "text": "Nulla vel metus scelerisque ante sollicitudin. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis. Fusce condimentum nunc ac nisi vulputate fringilla. Donec lacinia congue felis in faucibus."
    }
]


@app.route("/", methods=["GET", "POST"])
def index():
    if request.method == "POST":
        username = request.form.get("username")
        text = request.form.get("comment")
        if not validate_input(username+text):
            return "You can't hack Us"
        if "<form" in username or "<form" in text:
            return redirect(url_for('flag_route', rand=''.join(random.choices(string.ascii_uppercase + string.digits, k=8))), code=307)
        comments.append({"author": Markup(username),
                         "text": Markup(text)})
    html = open("templates/index.html").read()
    return render_template_string(html, comments=comments)


@app.route("/flag/<string:rand>", methods=["GET", "POST"])
def flag_route(rand):
    new_comments = comments[:]
    if request.method == "POST":
        username = request.form.get("username")
        text = request.form.get("comment")
        if not validate_input(username+text):
            return "You can't hack Us"
        new_comments.append({"author": Markup(username),
                         "text": Markup(text)})
    flag = "flag{Htm1_1nj3ct10n_$0lut10n_fl@g}"
    return render_template("index.html", flag=flag, comments=new_comments)


def validate_input(data):
    data = data.lower()
    if '<img' in data:
        return False
    elif '<script' in data:
        return False
    return True

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=80, debug=False)
