import datetime
import time

from websocket import create_connection
import ssl
import json
import requests


class PyChatAdminBot:
    def __init__(self):
        self.token = ""
        self.users = dict()
        self.login_as_admin()
        self.ws = create_connection(f'wss://localhost/ws?id=&sessionId={self.token}',
                                    sslopt={"cert_reqs": ssl.CERT_NONE})

        self.get_users_()

    def login_as_admin(self):
        r = requests.post("https://localhost/api/auth", params={"username": "admin", "password": "admin"}, verify=False)
        self.token = r.json()['session']

    def get_users_(self):
        result = self.ws.recv()
        # self.users = dict(map(lambda x: x["user"]: x["userId"], json.loads(result)["users"]))
        self.users = {x["user"]: x["userId"] for x in json.loads(result)["users"]}

    def get_messages_from_all_chats(self):
        all_messages = dict()
        for username, userid in self.users.items():
            if username == "admin":
                continue
            messages = self.get_messages_from_chat(userid)
            i = 0
            while not messages:
                messages = self.get_messages_from_chat(userid)
                if i >= 3:
                    print("Error read Messages :(")
                    break
                i += 1
            all_messages[username] = messages
        return all_messages

    def get_messages_from_chat(self, userid):

        request = '{"messagesIds":[],"receivedMessageIds":[],"onServerMessageIds":[],"roomIds":[1,' + str(userid) + \
                  '],"lastSynced":750221,"action":"syncHistory","cbId":1}'
        self.ws.send(request)
        result = json.loads(self.ws.recv())
        # format
        # {'userId': 3, 'content': 'hi', 'time': 1613247861718, 'id': 17, 'edited': 1613247861731, 'roomId': 3,
        #  'status': 'received', 'threadMessagesCount': 0, 'parentMessage': None, 'tags': {}}
        if not result.get("action"):
            messages = list(map(lambda x: (x["content"], x['time']), result["content"]))
            if not messages:
                return [("No Messages", 0)]
            return messages
        else:
            return False

    def send_message(self, userid, message):
        request = '{"files":[],"id":-1701069565,"timeDiff":23,"action":"printMessage","content":"' \
                  + message + '","tags":{},"parentMessage":null,"roomId":' + str(userid) + ',"cbId":10}'
        self.ws.send(request)
        result = json.loads(self.ws.recv())
        print(result)

    def message_hook(self, client_message, answer_message, action):
        for username, messages in self.get_messages_from_all_chats().items():
            for text, timestamp in messages:
                action(text)

    def check_new_messages(self, check_interval):
        for username, messages in self.get_messages_from_all_chats().items():
            for text, timestamp in messages:
                t = timestamp / 1000
                div = datetime.datetime.now() - datetime.datetime.fromtimestamp(t)
                if div.seconds < check_interval:
                    print(text)
            # print(time.gmtime(div))


    def run(self, check_interval):
        for _ in range(3):
            self.check_new_messages(check_interval)
            time.sleep(check_interval)
        self.close()

    def close(self):
        self.ws.close()


# bot = PyChatAdminBot()
# messages = bot.get_messages_from_all_chats()
# bot.send_message(3, "hello")
# bot.close()

bot = PyChatAdminBot()

# @bot.message_hook('test', 'comleat')
# def action():
#     pass

bot.run(check_interval=5)
# print(messages)
