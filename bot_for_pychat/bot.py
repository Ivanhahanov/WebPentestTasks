from websocket import create_connection
import ssl
import json


def get_messages_from_chat(userid):
    ws = create_connection(f'wss://localhost/ws?id=&sessionId=PhE4joHiFqdpFZHOabGjqZbDQYjIrWHH',
                           sslopt={"cert_reqs": ssl.CERT_NONE})
    ws.recv()
    ws.recv()
    request = '{"messagesIds":[],"receivedMessageIds":[],"onServerMessageIds":[],"roomIds":[1,' + str(userid) + \
              '],"lastSynced":750221,"action":"syncHistory","cbId":1}'
    ws.send(request)
    result = json.loads(ws.recv())
    ws.close()
    # format
    # {'userId': 3, 'content': 'hi', 'time': 1613247861718, 'id': 17, 'edited': 1613247861731, 'roomId': 3,
    #  'status': 'received', 'threadMessagesCount': 0, 'parentMessage': None, 'tags': {}}
    if not result.get("action"):
        messages = list(map(lambda x: (x["userId"], x["content"]), result["content"]))
        if messages == []:
            return [(0, "No Messages")]
        return messages
    else:
        return False


def get_users_():
    ws = create_connection(f'wss://localhost/ws?id=&sessionId=PhE4joHiFqdpFZHOabGjqZbDQYjIrWHH',
                           sslopt={"cert_reqs": ssl.CERT_NONE})
    result = ws.recv()
    return list(map(lambda x: (x["user"], x["userId"]), json.loads(result)["users"]))


if __name__ == '__main__':
    users = get_users_()

    for username, userid in users:
        if username == "admin":
            continue
        print(username)
        messages = get_messages_from_chat(userid)
        i = 0
        while not messages:
            messages = get_messages_from_chat(userid)
            if i >= 3:
                print("Error read Messages :(")
                break
            i += 1
        print(messages)
